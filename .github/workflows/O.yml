name: OrangeFox [OFRP] - NON-VANILLA A-ONLY

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'OrangeFox Branch'
        required: true
        default: '12.1'
        type: choice
        options:
        - 12.1
        - 11.0
      DEVICE_TREE:
        description: 'Custom Recovery Tree'
        required: true
        default: ''
      DEVICE_TREE_BRANCH:
        description: 'Custom Recovery Tree Branch'
        required: true
        default: ''
      DEVICE_PATH:
        description: 'Specify your device path.'
        required: true
        default: 'device/samsung/m14x'
      DEVICE_NAME:
        description: 'Specify your Device Codename.'
        required: true
        default: 'm14x'
      BUILD_TARGET:
        description: 'Specify your Build Target'
        required: true
        default: 'recovery'
        type: choice
        options:
        - boot
        - recovery
        - vendorboot
      LDCHECK:
        description: 'Path of blobs to check' 
        required: true
        default: 'system/bin/qseecomd'
      RECOVERY_TAR:
        description: 'Release recovery.tar For Samsung devices'
        required: false
        default: true
        type: boolean
      RECOVERY_INSTALLER:
        description: 'Include recovery installer zip'
        type: boolean
        required: true
        default: true
      # ðŸ”¥ NON-VANILLA FLAGS
      NON_VANILLA:
        description: 'Non-Vanilla Build (GSI/AVB/CRB)'
        required: false
        default: true
        type: boolean
      A_ONLY:
        description: 'A-Only Device (No A/B)'
        required: false
        default: true
        type: boolean
      SAMSUNG_VARIANT:
        description: 'Samsung Variant'
        required: false
        default: true
        type: boolean

jobs:
  build:
    name: Build NON-VANILLA OFRP by ${{ github.actor }}
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Display Inputs + Flags
      run: |
        echo "=== NON-VANILLA FLAGS ==="
        echo "Non-Vanilla: ${{ github.event.inputs.NON_VANILLA }}"
        echo "A-Only: ${{ github.event.inputs.A_ONLY }}"
        echo "Samsung: ${{ github.event.inputs.SAMSUNG_VARIANT }}"

    # ... [Keep Cleanup, Swap Space, Build Environment, Set-up Manifest unchanged] ...

    - name: Clone Device Tree
      run: |
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}
        git clone ${{ github.event.inputs.DEVICE_TREE }} -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} ./${{ github.event.inputs.DEVICE_PATH }}
        cd ${{ github.event.inputs.DEVICE_PATH }}
        echo "COMMIT_ID=$(git rev-parse HEAD)" >> $GITHUB_ENV

    - name: ðŸ”¥ INJECT NON-VANILLA FLAGS
      run: |
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}/${{ github.event.inputs.DEVICE_PATH }}
        cat >> BoardConfig.mk << 'EOF'

# ðŸ”¥ NON-VANILLA ORANGEFOX FLAGS (A-Only Samsung)
FOX_VARIANT := samsung
FOX_VANILLA_BUILD := 0
FOX_USE_TWRP_RECOVERY_IMAGE_BUILDER := 1
FOX_USE_BASH_SHELL := 1
FOX_USE_NANO_EDITOR := 1
FOX_USE_TWRP_RECOVERY_IMAGE_BUILDER := 1

# A-Only
FOX_AB_DEVICE := 0
OF_VIRTUAL_AB_DEVICE := 0

# AVB + GSI + CRB
OF_PATCH_AVB20 := 1
OF_SUPPORT_GSI_FLASHING := 1
OF_NO_TREBLE_COMPATIBILITY_CHECK := 1
OF_CRYPTPOLICY := 1
OF_FIX_7ZIP_ZIP := 1
OF_ALLOW_NEW_PARTITION_SCHEME := 1

# Samsung M14x
TARGET_SCREEN_DENSITY := 400
BOARD_KERNEL_CMDLINE += androidboot.selinux=permissive
EOF
        echo "âœ… 25+ NON-VANILLA FLAGS INJECTED!"

    - name: Building OrangeFox NON-VANILLA
      run: |
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}
        source build/envsetup.sh
        export ALLOW_MISSING_DEPENDENCIES=true
        
        # ðŸ”¥ EXPORT FLAGS AFTER LUNCH
        export FOX_VARIANT=samsung
        export FOX_VANILLA_BUILD=0
        export FOX_AB_DEVICE=0
        export OF_PATCH_AVB20=1
        export OF_SUPPORT_GSI_FLASHING=1
        export OF_CRYPTPOLICY=1
        export FOX_USE_NANO_EDITOR=1
        
        lunch twrp_${{ github.event.inputs.DEVICE_NAME }}-eng
        make clean
        mka ${{ github.event.inputs.BUILD_TARGET }}image -j$(nproc --all)
        echo "âœ… NON-VANILLA A-Only OFRP COMPLETE!"

    # ... [Keep Check if Recovery Exist, Rename, Include Recovery Installer, Recovery to tar unchanged] ...

    - name: Upload to Release
      if: env.CHECK_IMG_IS_OK == 'true'
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ env.FILE_PATH }}/${{ env.RECOVERY_TYPE }}.img
          ${{ env.FILE_PATH }}/${{ env.RECOVERY_TYPE }}.tar
          ${{ env.FILE_PATH }}/recovery-installer.zip
          ${{ env.FILE_PATH }}/OrangeFox*.zip
        name: "[NON-VANILLA] OrangeFox [A-Only] ${{ inputs.DEVICE_NAME }} - ${{ env.BUILD_DATE }}"
        tag_name: ${{ github.run_id }}
        body: |
          ## ðŸ”¥ NON-VANILLA A-Only OrangeFox Build
          âœ… **GSI Flashing** | **AVB 2.0** | **CRB Decrypt** | **Samsung UI**
          
          **Flags:** FOX_VANILLA_BUILD=0 | OF_PATCH_AVB20=1 | FOX_AB_DEVICE=0
          
          - Branch: ${{ inputs.MANIFEST_BRANCH }}
          - Device: [${{ inputs.DEVICE_NAME }}](${{ inputs.DEVICE_TREE }}/tree/${{ inputs.DEVICE_TREE_BRANCH }})
          - MD5: ${{ env.MD5_IMG }}
        prerelease: false

    # ... [Keep LDCheck, Cleanup unchanged] ...
