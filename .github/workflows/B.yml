name: OrangeFox [OFRP] - NON-VANILLA A-ONLY w/ ECHO BUTTON âœ…

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'OrangeFox Branch'
        required: true
        default: '12.1'
        type: choice
        options: [12.1, 11.0]
      DEVICE_TREE:
        description: 'Custom Recovery Tree'
        required: true
        default: ''
      DEVICE_TREE_BRANCH:
        description: 'Custom Recovery Tree Branch'
        required: true
        default: ''
      DEVICE_PATH:
        description: 'Device path'
        required: true
        default: 'device/samsung/m14x'
      DEVICE_NAME:
        description: 'Device Codename'
        required: true
        default: 'm14x'
      BUILD_TARGET:
        description: 'Build Target'
        required: true
        default: 'recovery'
        type: choice
        options: [boot, recovery, vendorboot]
      # ðŸ”¥ ECHO DEBUG BUTTON
      ECHO_DEBUG:
        description: 'ECHO Flags Only (DEBUG MODE)'
        required: false
        default: false
        type: boolean

jobs:
  build:
    name: Build OFRP by ${{ github.actor }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Display Flags
      run: |
        echo "ECHO DEBUG: ${{ github.event.inputs.ECHO_DEBUG }}"
        echo "Device: ${{ github.event.inputs.DEVICE_NAME }}"

    - name: Setup Environment
      run: |
        sudo apt update && sudo apt install -y git bc bison flex libssl-dev
        git clone https://gitlab.com/OrangeFox/misc/scripts
        cd scripts && sudo bash setup/android_build_env.sh

    - name: Sync OrangeFox
      run: |
        mkdir OrangeFox && cd OrangeFox
        git clone https://gitlab.com/OrangeFox/sync.git
        cd sync && ./orangefox_sync.sh --branch ${{ github.event.inputs.MANIFEST_BRANCH }} --path fox_12.1

    - name: Clone Device Tree
      run: |
        cd OrangeFox/fox_12.1
        git clone ${{ github.event.inputs.DEVICE_TREE }} -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} ${{ github.event.inputs.DEVICE_PATH }}

    - name: ðŸ”¥ INJECT FLAGS (${{ github.event.inputs.ECHO_DEBUG && 'ECHO' || 'REAL' }} MODE)
      run: |
        MODE="${{ github.event.inputs.ECHO_DEBUG && 'ECHO' || 'REAL' }}"
        echo "Injecting flags - $MODE MODE"
        cd OrangeFox/fox_12.1/${{ github.event.inputs.DEVICE_PATH }}
        
        if [ "$MODE" = "REAL" ]; then
          cat >> BoardConfig.mk << 'FLAGS'
FOX_VARIANT := samsung
FOX_VANILLA_BUILD := 0
FOX_AB_DEVICE := 0
OF_PATCH_AVB20 := 1
OF_SUPPORT_GSI_FLASHING := 1
FOX_USE_NANO_EDITOR := 1
FLAGS
        else
          cat >> BoardConfig.mk << 'ECHO'
# ECHO DEBUG MODE
echo FOX_VARIANT := samsung
echo FOX_VANILLA_BUILD := 0
ECHO
        fi
        echo "âœ… Flags injected ($MODE MODE)"

    - name: Build OrangeFox
      run: |
        cd OrangeFox/fox_12.1
        source build/envsetup.sh
        export ALLOW_MISSING_DEPENDENCIES=true
        export FOX_VARIANT=samsung
        export FOX_VANILLA_BUILD=0
        export FOX_AB_DEVICE=0
        lunch twrp_${{ github.event.inputs.DEVICE_NAME }}-eng
        mka ${{ github.event.inputs.BUILD_TARGET }}image -j$(nproc)

    - name: Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: OrangeFox-${{ github.event.inputs.DEVICE_NAME }}
        path: OrangeFox/fox_12.1/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.img
