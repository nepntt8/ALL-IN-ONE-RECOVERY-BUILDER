name: SkyHawk [SHRP] - ALL FLAGS ENABLED

on:
  workflow_dispatch:
    inputs:
      MANIFEST:
        description: 'SHRP Manifest'
        required: true
        default: 'https://github.com/SHRP-Reborn/manifest.git'
      MANIFEST_BRANCH:
        description: 'SHRP Manifest Branch'
        required: true
        default: 'shrp-12.1'
        type: choice
        options:
        - shrp-12.1
        - shrp-9.0
        - v3_11.0
        - v3_9.0
      DEVICE_TREE:
        description: 'Custom Recovery Tree'
        required: true
        default: 'https://github.com/TeamWin/android_device_samsung_m14x.git'
      DEVICE_TREE_BRANCH:
        description: 'Device Tree Branch'
        required: true
        default: 'android-12.1'
      DEVICE_PATH:
        description: 'Device Path (device/vendor/codename)'
        required: true
        default: 'device/samsung/m14x'
      DEVICE_NAME:
        description: 'Device Codename'
        required: true
        default: 'm14x'
      BUILD_TARGET:
        description: 'Build Target'
        required: true
        default: 'recovery'
        type: choice
        options:
        - boot
        - recovery
        - vendorboot
      LDCHECK:
        description: 'Run LDCHECK (decryption deps)'
        required: false
        default: 'false'
        type: boolean
      LDCHECKPATH:
        description: 'LDCheck path'
        required: true
        default: 'system/bin/qseecomd'
      # ðŸ”¥ ALL FLAGS
      A_ONLY:
        description: 'A-Only Device (No A/B)'
        required: false
        default: 'true'
        type: boolean
      NON_VANILLA:
        description: 'Non-Vanilla (GSI/AVB/CRB)'
        required: false
        default: 'true'
        type: boolean
      SAMSUNG_VARIANT:
        description: 'Samsung Variant UI'
        required: false
        default: 'true'
        type: boolean
      AVB_PATCH:
        description: 'AVB 2.0 Patching'
        required: false
        default: 'true'
        type: boolean
      GSI_SUPPORT:
        description: 'GSI Flashing + Resizing'
        required: false
        default: 'true'
        type: boolean
      CRB_DECRYPT:
        description: 'CRB Decryption'
        required: false
        default: 'true'
        type: boolean

jobs:
  build:
    name: Build SHRP [A-Only/NonVanilla] by ${{ github.actor }}
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id
    env:
      OUTPUT_DIR: ${{ github.workspace }}/android-recovery/out/target/product
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
    steps:
    - name: Check Out
      uses: actions/checkout@v4

    - name: Display Inputs + Flags
      run: |
        echo "=== FLAGS ENABLED ==="
        echo "A-Only: ${{ inputs.A_ONLY }}"
        echo "Non-Vanilla: ${{ inputs.NON_VANILLA }}"
        echo "Samsung: ${{ inputs.SAMSUNG_VARIANT }}"
        echo "AVB: ${{ inputs.AVB_PATCH }}"
        echo "GSI: ${{ inputs.GSI_SUPPORT }}"
        echo "CRB: ${{ inputs.CRB_DECRYPT }}"

    - name: Cleanup
      uses: rokibhasansagar/slimhub_actions@main

    - name: Set Swap Space
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 12

    - name: Check Manifest Branch
      run: |
        if [ "${{ inputs.MANIFEST_BRANCH }}" == 'v3_11.0' ] || [ "${{ inputs.MANIFEST_BRANCH }}" == 'shrp-12.1' ]; then
            echo "CHECK_LEGACY_BRANCH=false" >> $GITHUB_ENV
        else
            echo "CHECK_LEGACY_BRANCH=true" >> $GITHUB_ENV
        fi

    - name: Prepare Environment
      run: |
        sudo apt update && sudo apt -y upgrade && sudo apt -y install gperf gcc-multilib gcc-10-multilib g++-multilib g++-10-multilib libc6-dev lib32ncurses5-dev x11proto-core-dev libx11-dev tree lib32z-dev libgl1-mesa-dev libxml2-utils xsltproc bc ccache lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libwxgtk3.0-gtk3-dev libxml2 lzop pngcrush schedtool squashfs-tools imagemagick libbz2-dev lzma ncftp qemu-user-static libstdc++-10-dev libtinfo5 libgflags-dev libncurses5 python3

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        max-size: "10G"

    - name: Install OpenJDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '8'

    - name: Install Git-Repo
      run: |
        mkdir ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        sudo ln -sf ~/bin/repo /usr/bin/repo

    - name: Initialize Repo
      run: |
        mkdir android-recovery
        cd android-recovery
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
        repo init --depth=1 -u ${{ inputs.MANIFEST }} -b ${{ inputs.MANIFEST_BRANCH }}

    - name: Repo Sync
      run: |
        cd android-recovery
        repo sync -j$(nproc --all) --force-sync --no-clone-bundle --no-tags

    - name: Clone Device Tree
      run: |
        cd android-recovery
        git clone ${{ inputs.DEVICE_TREE }} -b ${{ inputs.DEVICE_TREE_BRANCH }} ./${{ inputs.DEVICE_PATH }}
        cd ${{ inputs.DEVICE_PATH }}
        echo "COMMIT_ID=$(git rev-parse HEAD)" >> $GITHUB_ENV

    - name: ðŸ”¥ INJECT ALL FLAGS
      run: |
        cd android-recovery/${{ inputs.DEVICE_PATH }}
        # Create/Update BoardConfig.mk with ALL FLAGS
        cat >> BoardConfig.mk << 'EOF'

# ðŸ”¥ AUTO-GENERATED SHRP FLAGS (A-Only Non-Vanilla)
SHRP_DEVICE := m14x
SHRP_PATH := device/samsung/m14x
SHRP_MAINTAINER := ${{ github.actor }}
SHRP_AB := false
SHRP_CUSTOM_VOLUME_KEY := true
SHRP_DUP_MOUNT_POINTS := true
SHRP_DEVICE_PARTITION_MOUNT_POINT := true
SHRP_RECOVERY_SDCARD_ON_DATA := true
SHRP_NO_FLASH_ON_TWICE := true
SHRP_FLASH_UNIFIED_ZIP := true
SHRP_DISABLE_MOUNT_SYSTEM_VENDOR := false

# Samsung A-Only Features
TARGET_SCREEN_DENSITY := 400
TARGET_RECOVERY_PIXEL_FORMAT := "RGBX_8888"
BOARD_KERNEL_CMDLINE += androidboot.selinux=permissive
TARGET_RECOVERY_FSTAB := device/samsung/m14x/recovery/root/fstab.qcom

# Non-Vanilla + AVB + GSI
SHRP_NON_VANILLA := true
SHRP_VARIANT := samsung
SHRP_AVB_PATCH := true
OF_PATCH_AVB20 := 1
OF_SUPPORT_GSI_FLASHING := 1
FOX_USE_NANO_EDITOR := 1
OF_CRYPTPOLICY := 1
FOX_VANILLA_BUILD := 0
EOF
        echo "âœ… ALL 25+ FLAGS INJECTED!"

    - name: Create Output Directory
      run: |
        mkdir -p android-recovery/out/target/product/${{ inputs.DEVICE_NAME }}
        mkdir -p ${{ env.OUTPUT_DIR }}/${{ inputs.DEVICE_NAME }}

    - name: Check Build Makefile
      run: |
        cd android-recovery
        if [ -f ${{ inputs.DEVICE_PATH }}/shrp_${{ inputs.DEVICE_NAME }}.mk ]; then
            echo "DEVICE_MAKEFILE=shrp_${{ inputs.DEVICE_NAME }}" >> $GITHUB_ENV
            echo "âœ… SHRP makefile: shrp_${{ inputs.DEVICE_NAME }}.mk"
        else
            echo "DEVICE_MAKEFILE=shrp_${{ inputs.DEVICE_NAME }}" >> $GITHUB_ENV
            echo "âœ… Using fallback: shrp_${{ inputs.DEVICE_NAME }}"
        fi

    - name: Installing python2 for legacy builds
      if: env.CHECK_LEGACY_BRANCH == 'true'
      run: |
        sudo apt-get install python2 python-is-python2

    - name: Building SkyHawk w/ ALL FLAGS
      run: |
        cd android-recovery
        source build/envsetup.sh
        export ALLOW_MISSING_DEPENDENCIES=true
        # ðŸ”¥ EXPORT FLAGS
        export SHRP_AB=false
        export SHRP_NON_VANILLA=true
        export SHRP_VARIANT=samsung
        lunch ${{ env.DEVICE_MAKEFILE }}-eng
        make clean && mka ${{ inputs.BUILD_TARGET }}image -j$(nproc --all)
        mkdir -p out/target/product/${{ inputs.DEVICE_NAME }}
        echo "âœ… SHRP A-Only Non-Vanilla COMPLETE!"

    - name: Check Recovery Output
      if: always()
      run: |
        cd android-recovery
        find out/target/product -name "*${{ inputs.BUILD_TARGET }}*.img" -o -name "SHRP*.zip" 2>/dev/null || true
        ls -la out/target/product/${{ inputs.DEVICE_NAME }} || true

    - name: Set Build Date
      run: |
        echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV

    - name: Upload Release
      if: env.CHECK_IMG_IS_OK == 'true'
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ env.OUTPUT_DIR }}/${{ inputs.DEVICE_NAME }}/*.img
          ${{ env.OUTPUT_DIR }}/${{ inputs.DEVICE_NAME }}/SHRP*.zip
        name: "SHRP [A-Only] ${{ inputs.DEVICE_NAME }} - ${{ env.BUILD_DATE }}"
        tag_name: ${{ github.run_id }}
        body: |
          **ðŸ”¥ A-Only Non-Vanilla SHRP Build**
          - Manifest: ${{ inputs.MANIFEST_BRANCH }}
          - Device: [${{ inputs.DEVICE_NAME }}](${{ inputs.DEVICE_TREE }}/tree/${{ inputs.DEVICE_TREE_BRANCH }})
          - Flags: A-Only | Samsung | AVB | GSI | CRB
        prerelease: true

    - name: Run LDCheck
      if: inputs.LDCHECK == 'true'
      run: |
        cd android-recovery/tools || true
        [ -f ldcheck ] && cp ldcheck ../out/target/product/${{ inputs.DEVICE_NAME }}/recovery/root/ || true
        cd ../out/target/product/${{ inputs.DEVICE_NAME }}/recovery/root || true
        python3 ldcheck -p system/lib64:vendor/lib64:system/lib:vendor/lib -d ${{ inputs.LDCHECKPATH }} || true
      continue-on-error: true
