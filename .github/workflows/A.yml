name: OrangeFox [OFRP] - NON-VANILLA A-ONLY + CRB TOOL âœ…

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'OrangeFox Branch'
        required: true
        default: '12.1'
        type: choice
        options: [12.1, 11.0]
      DEVICE_TREE:
        description: 'Custom Recovery Tree *REQUIRED*'
        required: true
      DEVICE_TREE_BRANCH:
        description: 'Device Tree Branch'
        required: true
        default: 'main'
      DEVICE_PATH:
        description: 'Device path'
        required: true
        default: 'device/samsung/m14x'
      DEVICE_NAME:
        description: 'Device Codename'
        required: true
        default: 'm14x'
      BUILD_TARGET:
        description: 'Build Target'
        required: true
        default: 'recovery'
        type: choice
        options: [boot, recovery, vendorboot]
      ECHO_DEBUG:
        description: 'ECHO Flags Only (DEBUG)'
        required: false
        default: false
        type: boolean
      CRB_PREP:
        description: 'Prepare CRB Kitchen Files'
        required: false
        default: false
        type: boolean

jobs:
  build:
    name: Build OFRP + CRB by ${{ github.actor }}
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Display Inputs
      run: |
        echo "Manifest: ${{ github.event.inputs.MANIFEST_BRANCH }}"
        echo "Device: ${{ github.event.inputs.DEVICE_NAME }}"
        echo "ECHO DEBUG: ${{ github.event.inputs.ECHO_DEBUG }}"
        echo "CRB PREP: ${{ github.event.inputs.CRB_PREP }}"

    - name: ðŸ”¥ Setup 24GB Swap (Manual)
      run: |
        sudo fallocate -l 24G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        echo 'vm.swappiness=10' | sudo tee -a /etc/sysctl.conf
        sudo sysctl vm.swappiness=10
        free -h
        echo "âœ… 24GB Swap ready!"

    - name: Build Environment + CRB Tools
      run: |
        sudo apt update && sudo apt install -y git bc bison flex libssl-dev \
        python3 python2 ccache repo make clang lld zip unzip wget bc python-is-python3
        git clone https://gitlab.com/OrangeFox/misc/scripts
        cd scripts && sudo bash setup/android_build_env.sh
        
        if [ "${{ github.event.inputs.CRB_PREP }}" = "true" ]; then
          mkdir -p crb-output
          echo "âœ… CRB Kitchen prep enabled!"
        fi

    - name: Sync OrangeFox (${{ github.event.inputs.MANIFEST_BRANCH }})
      run: |
        mkdir -p OrangeFox
        cd OrangeFox
        git clone https://gitlab.com/OrangeFox/sync.git
        cd sync
        ./orangefox_sync.sh --branch ${{ github.event.inputs.MANIFEST_BRANCH }} \
          --path fox_${{ github.event.inputs.MANIFEST_BRANCH }}

    - name: Clone Device Tree
      run: |
        cd OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}
        git clone ${{ github.event.inputs.DEVICE_TREE }} \
          -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} \
          ${{ github.event.inputs.DEVICE_PATH }}
        echo "âœ… Device tree cloned!"

    - name: ðŸ”¥ INJECT FLAGS (Method 4 - Array + Loop)
      run: |
        MODE="${{ github.event.inputs.ECHO_DEBUG && 'ECHO' || 'REAL' }}"
        echo "Injecting flags - $MODE MODE"
        cd "OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}/${{ github.event.inputs.DEVICE_PATH }}"
        
        if [ "$MODE" = "REAL" ]; then
          FLAGS=(
            "FOX_VARIANT := samsung"
            "FOX_VANILLA_BUILD := 0"
            "FOX_AB_DEVICE := 0"
            "OF_PATCH_AVB20 := 1"
            "OF_SUPPORT_GSI_FLASHING := 1"
            "FOX_USE_NANO_EDITOR := 1"
            "OF_CRYPTPOLICY := 1"
            "OF_FIX_7ZIP_ZIP := 1"
            "OF_USE_GREEN_LED := 1"
          )
          
          for flag in "${FLAGS[@]}"; do
            echo "$flag" >> BoardConfig.mk
          done
          echo "âœ… REAL FLAGS injected (${#FLAGS[@]} total)!"
        else
          ECHO_FLAGS=(
            "echo FOX_VARIANT := samsung"
            "echo FOX_VANILLA_BUILD := 0"
            "echo FOX_AB_DEVICE := 0"
          )
          
          for eflag in "${ECHO_FLAGS[@]}"; do
            echo "$eflag" >> BoardConfig.mk
          done
          echo "âœ… ECHO MODE injected (${#ECHO_FLAGS[@]} lines)!"
        fi
        
        echo "ðŸ“‹ BoardConfig.mk preview:"
        tail -10 BoardConfig.mk

    - name: Build OrangeFox
      run: |
        cd "OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}"
        source build/envsetup.sh
        export ALLOW_MISSING_DEPENDENCIES=true
        export FOX_VARIANT=samsung
        export FOX_VANILLA_BUILD=0
        export FOX_AB_DEVICE=0
        
        echo "Available lunch combos:"
        lunch | grep ${{ github.event.inputs.DEVICE_NAME }} || true
        
        lunch twrp_${{ github.event.inputs.DEVICE_NAME }}-eng
        mka ${{ github.event.inputs.BUILD_TARGET }}image -j$(nproc --all)

    - name: ðŸ”¥ CRB Kitchen Package (If Enabled)
      if: github.event.inputs.CRB_PREP == 'true'
      run: |
        echo "ðŸ“¦ Creating CRB-ready package..."
        mkdir -p crb-output/${{ github.event.inputs.DEVICE_NAME }}
        
        cp OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.img \
          crb-output/${{ github.event.inputs.DEVICE_NAME }}/
        
        mkdir -p crb-output/${{ github.event.inputs.DEVICE_NAME }}/ORIGINAL_UPDATE
        cp "OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}/${{ github.event.inputs.DEVICE_PATH }}/BoardConfig.mk" \
          crb-output/${{ github.event.inputs.DEVICE_NAME }}/BoardConfig.mk
        
        cd crb-output
        zip -r "${{ github.event.inputs.DEVICE_NAME }}-CRB-Package.zip" ${{ github.event.inputs.DEVICE_NAME }}/
        echo "âœ… CRB package: ${{ github.event.inputs.DEVICE_NAME }}-CRB-Package.zip"

    - name: Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: OrangeFox-${{ github.event.inputs.DEVICE_NAME }}-${{ github.event.inputs.MANIFEST_BRANCH }}
        path: |
          OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.img
          OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.zip
          crb-output/*.zip

    - name: Cleanup Swap
      if: always()
      run: |
        sudo swapoff /swapfile
        sudo rm -f /swapfile
        echo "ðŸ§¹ Swap cleaned up"
