name: OrangeFox [OFRP] - NON-VANILLA A-ONLY + CRB TOOL âœ… FIXED

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'OrangeFox Branch'
        required: true
        default: '12.1'
        type: choice
        options: [12.1, 11.0]
      DEVICE_TREE:
        description: 'Custom Recovery Tree *REQUIRED*'
        required: true
      DEVICE_TREE_BRANCH:
        description: 'Device Tree Branch'
        required: true
        default: 'main'
      DEVICE_PATH:
        description: 'Device path'
        required: true
        default: 'device/samsung/m14x'
      DEVICE_NAME:
        description: 'Device Codename'
        required: true
        default: 'm14x'
      BUILD_TARGET:
        description: 'Build Target'
        required: true
        default: 'recovery'
        type: choice
        options: [boot, recovery, vendorboot]
      ECHO_DEBUG:
        description: 'ECHO Flags Only (DEBUG)'
        required: false
        default: false
        type: boolean
      CRB_PREP:
        description: 'Prepare CRB Kitchen Files'
        required: false
        default: false
        type: boolean

jobs:
  build:
    name: Build OFRP + CRB by ${{ github.actor }}
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id
    steps:
    - name: ðŸ”¥ MAXIMIZE DISK SPACE (6GB FREE)
      uses: easimon/maximize-build-space@v1
      with:
        root-reserve-mb: 512
        swap-size-mb: 4096
        remove-dotnet: 'true'
        remove-uwp: 'true'

    - name: Disk Check Before
      run: |
        df -h
        free -h

    - name: Checkout
      uses: actions/checkout@v4

    - name: Display Inputs
      run: |
        echo "Manifest: ${{ github.event.inputs.MANIFEST_BRANCH }}"
        echo "Device: ${{ github.event.inputs.DEVICE_NAME }}"
        echo "ECHO DEBUG: ${{ github.event.inputs.ECHO_DEBUG }}"
        echo "CRB PREP: ${{ github.event.inputs.CRB_PREP }}"

    - name: Build Environment
      run: |
        sudo apt update && sudo apt install -y git bc bison flex libssl-dev \
        python3 python-is-python3 ccache repo make clang lld zip unzip wget
        git clone https://gitlab.com/OrangeFox/misc/scripts
        cd scripts && sudo bash setup/android_build_env.sh
        
        # Clean cache early
        sudo rm -rf /usr/local/lib/python3.*/site-packages/* || true

    - name: Sync OrangeFox (${{ github.event.inputs.MANIFEST_BRANCH }})
      run: |
        mkdir -p OrangeFox
        cd OrangeFox
        git clone https://gitlab.com/OrangeFox/sync.git
        cd sync
        ./orangefox_sync.sh --branch ${{ github.event.inputs.MANIFEST_BRANCH }} \
          --path fox_${{ github.event.inputs.MANIFEST_BRANCH }}
        
        echo "Disk after sync:"
        df -h .

    - name: Clone Device Tree
      run: |
        cd OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}
        git clone ${{ github.event.inputs.DEVICE_TREE }} \
          -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} \
          ${{ github.event.inputs.DEVICE_PATH }}
        echo "âœ… Device tree cloned!"

    - name: ðŸ”¥ INJECT FLAGS (Method 4)
      run: |
        MODE="${{ github.event.inputs.ECHO_DEBUG && 'ECHO' || 'REAL' }}"
        cd "OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}/${{ github.event.inputs.DEVICE_PATH }}"
        
        if [ "$MODE" = "REAL" ]; then
          FLAGS=(
            "FOX_VARIANT := samsung"
            "FOX_VANILLA_BUILD := 0"
            "FOX_AB_DEVICE := 0"
            "OF_PATCH_AVB20 := 1"
            "OF_SUPPORT_GSI_FLASHING := 1"
            "FOX_USE_NANO_EDITOR := 1"
          )
          for flag in "${FLAGS[@]}"; do echo "$flag" >> BoardConfig.mk; done
          echo "âœ… REAL FLAGS (${#FLAGS[@]})"
        else
          for flag in "echo FOX_VARIANT := samsung" "echo FOX_VANILLA_BUILD := 0"; do
            echo "$flag" >> BoardConfig.mk
          done
          echo "âœ… ECHO MODE"
        fi
        tail -7 BoardConfig.mk

    - name: Build OrangeFox
      run: |
        cd "OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}"
        source build/envsetup.sh
        export ALLOW_MISSING_DEPENDENCIES=true
        lunch twrp_${{ github.event.inputs.DEVICE_NAME }}-eng || lunch 1
        
        echo "Building ${{ github.event.inputs.BUILD_TARGET }}..."
        mka ${{ github.event.inputs.BUILD_TARGET }}image -j$(nproc --all)

    - name: ðŸ”¥ CRB Package
      if: github.event.inputs.CRB_PREP == 'true'
      run: |
        mkdir -p crb-output/${{ github.event.inputs.DEVICE_NAME }}
        cp OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.img \
          crb-output/${{ github.event.inputs.DEVICE_NAME }}/
        cd crb-output && zip -r "${{ github.event.inputs.DEVICE_NAME }}-CRB.zip" *

    - name: Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: OFRP-${{ github.event.inputs.DEVICE_NAME }}-${{ github.event.inputs.MANIFEST_BRANCH }}
        path: |
          OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.img
          OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.zip
          crb-output/*.zip
        retention-days: 7

    - name: Final Disk Check
      if: always()
      run: |
        df -h
        du -sh OrangeFox/ || true
