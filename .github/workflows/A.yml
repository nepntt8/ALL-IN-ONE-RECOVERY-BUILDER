name: OrangeFox [OFRP] - NON-VANILLA A-ONLY + CRB TOOL âœ… DISK FIXED

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'OrangeFox Branch'
        required: true
        default: '12.1'
        type: choice
        options: [12.1, 11.0]
      DEVICE_TREE:
        description: 'Custom Recovery Tree *REQUIRED*'
        required: true
      DEVICE_TREE_BRANCH:
        description: 'Device Tree Branch'
        required: true
        default: 'main'
      DEVICE_PATH:
        description: 'Device path'
        required: true
        default: 'device/samsung/m14x'
      DEVICE_NAME:
        description: 'Device Codename'
        required: true
        default: 'm14x'
      BUILD_TARGET:
        description: 'Build Target'
        required: true
        default: 'recovery'
        type: choice
        options: [boot, recovery, vendorboot]
      ECHO_DEBUG:
        description: 'ECHO Flags Only (DEBUG)'
        required: false
        default: false
        type: boolean
      CRB_PREP:
        description: 'Prepare CRB Kitchen Files'
        required: false
        default: false
        type: boolean

jobs:
  build:
    name: Build OFRP + CRB by ${{ github.actor }}
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id
    steps:
    - name: ðŸ”¥ Manual Disk Cleanup (SAFE)
      run: |
        # Safe cleanup - no filesystem creation
        sudo rm -rf /usr/share/dotnet /opt/hostedtoolcache /usr/local/lib/android
        sudo apt clean
        docker system prune -af || true
        df -h .
        echo "âœ… Disk cleaned (no lost+found created)"

    - name: ðŸ”¥ 8GB Swap (Safe)
      run: |
        sudo fallocate -l 8G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        echo 'vm.swappiness=10' | sudo tee -a /etc/sysctl.conf
        free -h
        echo "âœ… 8GB Swap ready!"

    - name: Checkout (Now Safe)
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Display Inputs
      run: |
        echo "Manifest: ${{ github.event.inputs.MANIFEST_BRANCH }}"
        echo "Device: ${{ github.event.inputs.DEVICE_NAME }}"
        echo "ECHO: ${{ github.event.inputs.ECHO_DEBUG }}"
        echo "CRB: ${{ github.event.inputs.CRB_PREP }}"
        df -h .

    - name: Build Environment
      run: |
        sudo apt update && sudo apt install -y git bc bison flex libssl-dev \
        python3 python-is-python3 ccache repo make clang lld zip unzip wget
        git clone https://gitlab.com/OrangeFox/misc/scripts
        cd scripts && sudo bash setup/android_build_env.sh

    - name: Sync OrangeFox (${{ github.event.inputs.MANIFEST_BRANCH }})
      run: |
        mkdir -p OrangeFox
        cd OrangeFox
        git clone https://gitlab.com/OrangeFox/sync.git
        cd sync
        ./orangefox_sync.sh --branch ${{ github.event.inputs.MANIFEST_BRANCH }} \
          --path fox_${{ github.event.inputs.MANIFEST_BRANCH }}
        echo "âœ… Sync complete"
        df -h .

    - name: Clone Device Tree
      run: |
        cd OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}
        git clone ${{ github.event.inputs.DEVICE_TREE }} \
          -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} \
          ${{ github.event.inputs.DEVICE_PATH }}
        echo "âœ… Device tree cloned!"

    - name: ðŸ”¥ INJECT FLAGS (Method 4 - Compact)
      run: |
        MODE="${{ github.event.inputs.ECHO_DEBUG && 'ECHO' || 'REAL' }}"
        cd "OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}/${{ github.event.inputs.DEVICE_PATH }}"
        
        if [ "$MODE" = "REAL" ]; then
          printf '%s
' \
            "FOX_VARIANT := samsung" \
            "FOX_VANILLA_BUILD := 0" \
            "FOX_AB_DEVICE := 0" \
            "OF_PATCH_AVB20 := 1" \
            "OF_SUPPORT_GSI_FLASHING := 1" \
            "FOX_USE_NANO_EDITOR := 1" \
            "" >> BoardConfig.mk
          echo "âœ… REAL FLAGS (6)"
        else
          printf '%s
' \
            "# ECHO DEBUG MODE" \
            "echo FOX_VARIANT := samsung" \
            "echo FOX_VANILLA_BUILD := 0" \
            "" >> BoardConfig.mk
          echo "âœ… ECHO MODE"
        fi
        tail -8 BoardConfig.mk

    - name: Build OrangeFox
      run: |
        cd "OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}"
        source build/envsetup.sh
        export ALLOW_MISSING_DEPENDENCIES=true
        
        echo "Available targets:"
        lunch | grep -i ${{ github.event.inputs.DEVICE_NAME }} || echo "Using default"
        
        lunch twrp_${{ github.event.inputs.DEVICE_NAME }}-eng || lunch 1
        mka ${{ github.event.inputs.BUILD_TARGET }}image -j$(nproc --all)

    - name: ðŸ”¥ CRB Package (If Enabled)
      if: github.event.inputs.CRB_PREP == 'true'
      run: |
        mkdir -p crb-output/${{ github.event.inputs.DEVICE_NAME }}
        cp OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.img \
          crb-output/${{ github.event.inputs.DEVICE_NAME }}/
        cd crb-output && zip -r "${{ github.event.inputs.DEVICE_NAME }}-CRB.zip" *

    - name: Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: OFRP-${{ github.event.inputs.DEVICE_NAME }}-${{ github.event.inputs.MANIFEST_BRANCH }}
        path: |
          OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.img
          OrangeFox/fox_${{ github.event.inputs.MANIFEST_BRANCH }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.zip
          crb-output/*.zip
        retention-days: 5

    - name: Cleanup
      if: always()
      run: |
        sudo swapoff /swapfile || true
        sudo rm -f /swapfile
        echo "âœ… Cleanup complete"
