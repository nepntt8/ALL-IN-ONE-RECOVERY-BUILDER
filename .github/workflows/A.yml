name: OrangeFox [OFRP]

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'OrangeFox Branch'
        required: true
        default: '12.1'
        type: choice
        options: [12.1, 11.0]
      DEVICE_TREE:
        description: 'Custom Recovery Tree'
        required: true
        default: ''
      DEVICE_TREE_BRANCH:
        description: 'Custom Recovery Tree Branch'
        required: true
        default: ''
      DEVICE_PATH:
        description: 'Specify your device path.'
        required: true
        default: 'device/tecno/KJ5'
      DEVICE_NAME:
        description: 'Specify your Device Codename.'
        required: true
        default: 'KJ5'
      BUILD_TARGET:
        description: 'Specify your Build Target'
        required: true
        default: 'vendorboot'
        type: choice
        options: [boot, recovery, vendorboot]
      LDCHECK:
        description: 'Path of blobs to check'
        required: true
        default: 'system/bin/qseecomd'
      RECOVERY_TAR:
        description: 'Release recovery.tar For Samsung devices'
        required: false
        default: false
        type: boolean
      RECOVERY_INSTALLER:
        description: 'Include recovery installer zip'
        type: boolean
        required: true
        default: true
      CRB_PREP:
        description: 'Prepare CRB Kitchen Files'
        required: false
        default: false
        type: boolean

jobs:
  build:
    name: Build OFRP + CRB by ${{ github.actor }}
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
    - run: echo "::group::User Environment Variables
Installer: ${{ inputs.RECOVERY_INSTALLER }}
TAR: ${{ inputs.RECOVERY_TAR }}
CRB: ${{ inputs.CRB_PREP }}::endgroup::"
    - uses: rokibhasansagar/slimhub_actions@main
    - uses: pierotofy/set-swap-space@v2
      with:
        swap-size-gb: 24
    - run: sudo apt update && sudo apt -y upgrade && rm -rf scripts && git clone https://gitlab.com/OrangeFox/misc/scripts && cd scripts && sudo bash setup/android_build_env.sh
    - if: contains(fromJSON('["11.0", "12.1"]'), inputs.MANIFEST_BRANCH)
      run: mkdir -p ${GITHUB_WORKSPACE}/OrangeFox && cd ${GITHUB_WORKSPACE}/OrangeFox && git config --global user.name "${{ github.actor }}" && git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com" && git clone https://gitlab.com/OrangeFox/sync.git && cd sync && ./orangefox_sync.sh --branch ${{ inputs.MANIFEST_BRANCH }} --path ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
    - run: cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }} && git clone ${{ inputs.DEVICE_TREE }} -b ${{ inputs.DEVICE_TREE_BRANCH }} ./${{ inputs.DEVICE_PATH }} && cd ${{ inputs.DEVICE_PATH }} && echo "COMMIT_ID=$(git rev-parse HEAD)" >> $GITHUB_ENV

    # ðŸ”¥ 28 NON-VANILLA FLAGS
    - run: echo "FOX_VANILLA_BUILD := 0" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "OF_DISABLE_MIUI_SPECIFIC_FEATURES := 0" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "OF_TREBLE_CHECK_ON_REBOOT := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "FOX_AVB := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "OF_PATCH_AVB20 := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "OF_USE_MAGISKBOOT := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "OF_USE_MAGISKBOOT_FOR_ALL_PATCHES := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "OF_DEFAULT_KEYMASTER_VERSION := 4.1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "OF_SUPPORT_GSI_FLASHING := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "OF_KEEP_GSI_PARTIALLY_DECRYPTED := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "OF_NO_TREBLE_COMPATIBILITY_CHECK := 0" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "OF_GSI_MODE := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "FOX_VARIANT := samsung" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "FOX_DYNAMIC_SAMSUNG_FIX := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "OF_SAMSUNG_SPECIAL := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "OF_FLASH_BY_FASTBOOT := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "FOX_SAMSUNG_0x2000_SBL_FLASH := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "FOX_FORCE_SBL1_FLASH := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "FOX_USE_NANO_EDITOR := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "OF_CRYPTPOLICY := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "OF_FIX_7ZIP_ZIP := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "OF_USE_GREEN_LED := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "FOX_USE_TWRP_RECOVERY_IMAGE_BUILDER := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "OF_QUICK_BACKUP_WIPE := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "OF_USE_ASH := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "FOX_REPLACE_BUSYBOX_PS := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "OF_SUPPORT_MIUI_JMIUI_BOOTMODE := 1" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk
    - run: echo "FOX_AB_DEVICE := 0" >> ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk

    # ðŸ”¥ FLAGS SUMMARY
    - run: echo "::group::âœ… 28 NON-VANILLA FLAGS + CRB PREP
$(tail -25 ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk)::endgroup::"

    # ðŸ”¥ BUILD
    - id: build-cmd
      run: '[[ "${{ inputs.MANIFEST_BRANCH }}" == "11.0" || "${{ inputs.MANIFEST_BRANCH }}" == "12.1" ]] && echo "command=lunch twrp_${{ inputs.DEVICE_NAME }}-eng && make clean && mka adbd ${{ inputs.BUILD_TARGET }}image" >> $GITHUB_OUTPUT || echo "command=lunch omni_${{ inputs.DEVICE_NAME }}-eng && make clean && mka ${{ inputs.BUILD_TARGET }}image" >> $GITHUB_OUTPUT && echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV'
    - run: cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }} && source build/envsetup.sh && export ALLOW_MISSING_DEPENDENCIES=true && eval "${{ steps.build-cmd.outputs.command }}"

    # ðŸ”¥ IMAGE CHECK + RENAME
    - run: 'cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }} && ORANGEFOX_IMG=$(find out/target/product/${{ inputs.DEVICE_NAME }} -name "OrangeFox*.img" | head -1) && [[ -n "$ORANGEFOX_IMG" ]] && echo "CHECK_IMG_IS_OK=true" >> $GITHUB_ENV && echo "FILE_PATH=$(dirname "$ORANGEFOX_IMG")" >> $GITHUB_ENV && echo "MD5_IMG=$(md5sum "$ORANGEFOX_IMG" | cut -d" " -f1)" >> $GITHUB_ENV || echo "CHECK_IMG_IS_OK=false" >> $GITHUB_ENV'
    - if: env.CHECK_IMG_IS_OK == 'true'
      run: 'cd ${{ env.FILE_PATH }} && case "${{ inputs.BUILD_TARGET }}" in "boot") mv OrangeFox*.img boot.img; echo "RECOVERY_TYPE=boot" >> $GITHUB_ENV;; "recovery") mv OrangeFox*.img recovery.img; echo "RECOVERY_TYPE=recovery" >> $GITHUB_ENV;; "vendorboot") mv OrangeFox*.img vendor_boot.img; echo "RECOVERY_TYPE=vendor_boot" >> $GITHUB_ENV;; esac'

    # ðŸ”¥ PACKAGING
    - if: env.CHECK_IMG_IS_OK == 'true' && inputs.RECOVERY_INSTALLER == 'true'
      run: cd ${{ env.FILE_PATH }} && wget -q https://github.com/kinguser981/recovery-installer/releases/download/11256427880/recovery-installer.zip && zip -ur recovery-installer.zip ${{ env.RECOVERY_TYPE }}.img
    - if: env.CHECK_IMG_IS_OK == 'true' && inputs.RECOVERY_TAR == 'true'
      run: cd ${{ env.FILE_PATH }} && tar -cvf ${{ env.RECOVERY_TYPE }}.tar ${{ env.RECOVERY_TYPE }}.img

    # ðŸ”¥ CRB KITCHEN PREP
    - if: inputs.CRB_PREP == 'true'
      run: mkdir -p crb-output/${{ inputs.DEVICE_NAME }} && cp ${{ env.FILE_PATH }}/*.img crb-output/${{ inputs.DEVICE_NAME }}/ && mkdir -p crb-output/${{ inputs.DEVICE_NAME }}/ORIGINAL_UPDATE && cp ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk crb-output/${{ inputs.DEVICE_NAME }}/ORIGINAL_UPDATE/ && cd crb-output && zip -r "${{ inputs.DEVICE_NAME }}-CRB-Kitchen.zip" ${{ inputs.DEVICE_NAME }} && echo "::group::âœ… CRB PACKAGE READY
${{ inputs.DEVICE_NAME }}-CRB-Kitchen.zip created!::endgroup::"

    # ðŸ”¥ RELEASE
    - if: env.CHECK_IMG_IS_OK == 'true'
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ env.FILE_PATH }}/${{ env.RECOVERY_TYPE }}.img
          ${{ env.FILE_PATH }}/${{ env.RECOVERY_TYPE }}.tar
          ${{ env.FILE_PATH }}/recovery-installer.zip
          ${{ env.FILE_PATH }}/OrangeFox*.zip
          crb-output/*.zip
        name: OrangeFox [NON-VANILLA+CRB] [${{ inputs.DEVICE_NAME }}] - ${{ env.BUILD_DATE }}
        tag_name: ${{ github.run_id }}
        body: |
          ## ðŸ—ï¸ NON-VANILLA + CRB BUILD (28 FLAGS)
          - **Date:** ${{ env.BUILD_DATE }}
          - **Branch:** ${{ inputs.MANIFEST_BRANCH }}
          - **Device:** `${{ inputs.DEVICE_NAME }}`
          - **Target:** `${{ inputs.BUILD_TARGET }}`
          - **MD5:** `${{ env.MD5_IMG }}`
          
          âœ… **28 FLAGS + CRB Kitchen**: GSI+AVB2.0+Samsung+Magiskboot
        prerelease: false
        draft: false

    # ðŸ”¥ LDCHECK
    - if: env.CHECK_IMG_IS_OK == 'true'
      continue-on-error: true
      run: mkdir -p tools && cd tools && wget -q https://github.com/orao/ldcheck/releases/download/v0.1/ldcheck-linux.zip || true && unzip -qo ldcheck-linux.zip 2>/dev/null || true && mv -n libneeds* ${{ env.FILE_PATH }}/ 2>/dev/null || true && mv -n ldcheck ${{ env.FILE_PATH }}/ 2>/dev/null || true && cd ${{ env.FILE_PATH }} && python3 ldcheck -p "system/lib64:vendor/lib64:system/lib:vendor/lib" -d ${{ inputs.LDCHECK }}

    # ðŸ”¥ CLEANUP
    - if: always()
      run: rm -rf ${GITHUB_WORKSPACE}/OrangeFox scripts && df -h
